{% extends "base.html" %}
{% block title %}Patients - Blood Bank Management System{% endblock %}

{% block page_title %}Patients Management{% endblock %}
{% block page_subtitle %}Patient database and urgent request tracking{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
  <button class="btn btn-outline-light btn-sm" onclick="exportPatients()">
    <i class="bi bi-download me-2"></i>
    Export
  </button>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPatientModal">
    <i class="bi bi-person-plus me-2"></i>
    Add Patient
  </button>
</div>
{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="stats-grid mb-4" style="grid-template-columns: repeat(4, 1fr); gap: 1rem;">
  <div class="stat-card danger fade-in">
    <div class="stat-header">
      <div class="stat-title">Critical Cases</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
    </div>
    <div class="stat-value" id="criticalCases" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">Urgent attention needed</div>
  </div>

  <div class="stat-card warning fade-in">
    <div class="stat-header">
      <div class="stat-title">Moderate Cases</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-clock"></i>
      </div>
    </div>
    <div class="stat-value" id="moderateCases" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">Scheduled requests</div>
  </div>

  <div class="stat-card success fade-in">
    <div class="stat-header">
      <div class="stat-title">Routine Cases</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-calendar-check"></i>
      </div>
    </div>
    <div class="stat-value" id="routineCases" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">Standard procedures</div>
  </div>

  <div class="stat-card info fade-in">
    <div class="stat-header">
      <div class="stat-title">Total Patients</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-people"></i>
      </div>
    </div>
    <div class="stat-value" id="totalPatients" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">All registered</div>
  </div>
</div>

<!-- Filters Section -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-funnel me-2"></i>
      Filters & Search
    </h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Blood Type</label>
        <select class="form-select" id="bloodTypeFilter">
          <option value="">All Types</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">City</label>
        <select class="form-select" id="cityFilter">
          <option value="">All Cities</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Urgency</label>
        <select class="form-select" id="urgencyFilter">
          <option value="">All Levels</option>
          <option value="critical">Critical</option>
          <option value="moderate">Moderate</option>
          <option value="routine">Routine</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Severity</label>
        <select class="form-select" id="severityFilter">
          <option value="">All Severities</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Hospital</label>
        <select class="form-select" id="hospitalFilter">
          <option value="">All Hospitals</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <button class="btn btn-primary w-100" onclick="applyFilters()">
          <i class="bi bi-search me-2"></i>
          Apply
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Patients Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-table me-2"></i>
      Patients Database
    </h5>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-light btn-sm" onclick="refreshTable()">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-three-dots"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-dark">
          <li><a class="dropdown-item" href="#" onclick="exportPatients()"><i class="bi bi-download me-2"></i>Export CSV</a></li>
          <li><a class="dropdown-item" href="#" onclick="printTable()"><i class="bi bi-printer me-2"></i>Print</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="bulkActions()"><i class="bi bi-gear me-2"></i>Bulk Actions</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table id="patientsTable" class="table table-dark table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th><input type="checkbox" class="form-check-input" id="selectAll"></th>
            <th>ID</th>
            <th>Name</th>
            <th>Blood Type</th>
            <th>Age</th>
            <th>Gender</th>
            <th>City</th>
            <th>Hospital</th>
            <th>Severity</th>
            <th>Urgency</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1" aria-labelledby="addPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="addPatientModalLabel">
          <i class="bi bi-person-plus me-2"></i>
          Add New Patient
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addPatientForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Blood Type</label>
              <select class="form-select" name="blood_type" required>
                <option value="">Select Blood Type</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Age</label>
              <input type="number" class="form-control" name="age" min="1" max="120" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Gender</label>
              <select class="form-select" name="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Urgency Level</label>
              <select class="form-select" name="urgency_level" required>
                <option value="">Select Urgency</option>
                <option value="critical">Critical</option>
                <option value="moderate">Moderate</option>
                <option value="routine">Routine</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">City</label>
              <input type="text" class="form-control" name="city" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Hospital</label>
              <input type="text" class="form-control" name="hospital" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Severity</label>
              <select class="form-select" name="severity">
                <option value="">Select Severity</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Contact Number</label>
              <input type="tel" class="form-control" name="phone">
            </div>
            <div class="col-12">
              <label class="form-label">Medical Notes</label>
              <textarea class="form-control" name="notes" rows="3" placeholder="Additional medical information..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePatient()">
          <i class="bi bi-check-lg me-2"></i>
          Save Patient
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables CSS & JS CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
let patientsTable;
let allPatients = [];

$(document).ready(function() {
  loadPatients();
});

function loadPatients() {
  fetch('/patients')
    .then(response => response.json())
    .then(data => {
      allPatients = data;
      updateStats(data);
      populateFilters(data);
      initializeTable(data);
    })
    .catch(error => {
      console.error('Error loading patients:', error);
      showNotification('Error loading patients data', 'error');
    });
}

function updateStats(patients) {
  document.getElementById('totalPatients').textContent = patients.length;
  
  const critical = patients.filter(p => (p.urgency_level || '').toLowerCase() === 'critical').length;
  const moderate = patients.filter(p => (p.urgency_level || '').toLowerCase() === 'moderate').length;
  const routine = patients.filter(p => (p.urgency_level || '').toLowerCase() === 'routine').length;
  
  document.getElementById('criticalCases').textContent = critical;
  document.getElementById('moderateCases').textContent = moderate;
  document.getElementById('routineCases').textContent = routine;
}

function populateFilters(patients) {
  // Populate city filter
  const cities = [...new Set(patients.map(p => p.location?.city).filter(Boolean))].sort();
  const cityFilter = document.getElementById('cityFilter');
  cityFilter.innerHTML = '<option value="">All Cities</option>';
  cities.forEach(city => {
    cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
  });
  
  // Populate hospital filter
  const hospitals = [...new Set(patients.map(p => p.location?.hospital).filter(Boolean))].sort();
  const hospitalFilter = document.getElementById('hospitalFilter');
  hospitalFilter.innerHTML = '<option value="">All Hospitals</option>';
  hospitals.forEach(hospital => {
    hospitalFilter.innerHTML += `<option value="${hospital}">${hospital}</option>`;
  });
}

function initializeTable(data) {
  if (patientsTable) {
    patientsTable.destroy();
  }
  
  patientsTable = $('#patientsTable').DataTable({
    data: data,
    columns: [
      { 
        data: null,
        orderable: false,
        render: function(data, type, row) {
          return `<input type="checkbox" class="form-check-input patient-checkbox" value="${row.patient_id}">`;
        }
      },
      { data: 'patient_id' },
      { 
        data: 'name',
        render: function(data, type, row) {
          return `<div class="d-flex align-items-center">
                    <div class="avatar-sm bg-info rounded-circle d-flex align-items-center justify-content-center me-2">
                      <i class="bi bi-person text-white"></i>
                    </div>
                    <strong>${data}</strong>
                  </div>`;
        }
      },
      { 
        data: 'blood_type',
        render: function(data, type, row) {
          const colors = {
            'A+': 'bg-danger', 'A-': 'bg-danger',
            'B+': 'bg-warning', 'B-': 'bg-warning',
            'AB+': 'bg-info', 'AB-': 'bg-info',
            'O+': 'bg-success', 'O-': 'bg-success'
          };
          return `<span class="badge ${colors[data] || 'bg-secondary'} rounded-pill">${data}</span>`;
        }
      },
      { data: 'age' },
      { 
        data: 'gender',
        render: function(data, type, row) {
          const icon = data === 'Male' ? 'bi-gender-male' : data === 'Female' ? 'bi-gender-female' : 'bi-gender-ambiguous';
          return `<i class="bi ${icon} me-1"></i>${data}`;
        }
      },
      { 
        data: 'location.city',
        defaultContent: '',
        render: function(data, type, row) {
          return data ? `<i class="bi bi-geo-alt me-1"></i>${data}` : '-';
        }
      },
      { 
        data: 'location.hospital',
        defaultContent: '',
        render: function(data, type, row) {
          return data ? `<i class="bi bi-hospital me-1"></i>${data}` : '-';
        }
      },
      { 
        data: 'severity',
        defaultContent: '',
        render: function(data, type, row) {
          if (!data) return '-';
          const colors = {
            'high': 'bg-danger',
            'medium': 'bg-warning',
            'low': 'bg-success'
          };
          return `<span class="badge ${colors[data.toLowerCase()] || 'bg-secondary'}">${data}</span>`;
        }
      },
      { 
        data: 'urgency_level',
        defaultContent: '',
        render: function(data, type, row) {
          if (!data) return '-';
          const colors = {
            'critical': 'bg-danger',
            'moderate': 'bg-warning',
            'routine': 'bg-success'
          };
          const icons = {
            'critical': 'bi-exclamation-triangle-fill',
            'moderate': 'bi-clock-fill',
            'routine': 'bi-calendar-check-fill'
          };
          return `<span class="badge ${colors[data.toLowerCase()] || 'bg-secondary'}">
                    <i class="bi ${icons[data.toLowerCase()] || 'bi-info-circle'} me-1"></i>
                    ${data}
                  </span>`;
        }
      },
      {
        data: null,
        orderable: false,
        render: function(data, type, row) {
          return `
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary btn-sm" onclick="viewPatient('${row.patient_id}')" title="View">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="findMatches('${row.patient_id}')" title="Find Matches">
                <i class="bi bi-search-heart"></i>
              </button>
              <button class="btn btn-outline-warning btn-sm" onclick="editPatient('${row.patient_id}')" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
            </div>
          `;
        }
      }
    ],
    responsive: true,
    pageLength: 25,
    order: [[9, 'desc'], [1, 'asc']], // Sort by urgency first, then by ID
    dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center gap-2"l<"ms-2"f>><"ms-auto"B>>rtip',
    buttons: [
      {
        extend: 'csv',
        text: '<i class="bi bi-download me-1"></i>CSV',
        className: 'btn btn-outline-light btn-sm'
      },
      {
        extend: 'print',
        text: '<i class="bi bi-printer me-1"></i>Print',
        className: 'btn btn-outline-light btn-sm'
      }
    ],
    language: {
      search: '',
      searchPlaceholder: 'Search patients...',
      lengthMenu: 'Show _MENU_ patients',
      info: 'Showing _START_ to _END_ of _TOTAL_ patients',
      paginate: {
        previous: '<i class="bi bi-chevron-left"></i>',
        next: '<i class="bi bi-chevron-right"></i>'
      }
    },
    drawCallback: function() {
      // Style the search input
      $('.dataTables_filter input').addClass('form-control form-control-sm').attr('placeholder', 'Search patients...');
      $('.dataTables_length select').addClass('form-select form-select-sm');
    }
  });
}

function applyFilters() {
  const bloodType = document.getElementById('bloodTypeFilter').value;
  const city = document.getElementById('cityFilter').value;
  const urgency = document.getElementById('urgencyFilter').value;
  const severity = document.getElementById('severityFilter').value;
  const hospital = document.getElementById('hospitalFilter').value;
  
  let filtered = allPatients;
  
  if (bloodType) {
    filtered = filtered.filter(p => p.blood_type === bloodType);
  }
  if (city) {
    filtered = filtered.filter(p => p.location?.city === city);
  }
  if (urgency) {
    filtered = filtered.filter(p => (p.urgency_level || '').toLowerCase() === urgency.toLowerCase());
  }
  if (severity) {
    filtered = filtered.filter(p => (p.severity || '').toLowerCase() === severity.toLowerCase());
  }
  if (hospital) {
    filtered = filtered.filter(p => p.location?.hospital === hospital);
  }
  
  patientsTable.clear().rows.add(filtered).draw();
  updateStats(filtered);
}

function refreshTable() {
  loadPatients();
  showNotification('Patients data refreshed successfully', 'success');
}

function viewPatient(patientId) {
  const patient = allPatients.find(p => p.patient_id === patientId);
  if (patient) {
    console.log('View patient:', patient);
  }
}

function findMatches(patientId) {
  // Navigate to smart matching page
  window.location.href = `/smart_matching/${patientId}`;
}

function editPatient(patientId) {
  const patient = allPatients.find(p => p.patient_id === patientId);
  if (patient) {
    console.log('Edit patient:', patient);
  }
}

function savePatient() {
  const form = document.getElementById('addPatientForm');
  const formData = new FormData(form);
  
  console.log('Save patient:', Object.fromEntries(formData));
  
  bootstrap.Modal.getInstance(document.getElementById('addPatientModal')).hide();
  showNotification('Patient added successfully', 'success');
}

function exportPatients() {
  patientsTable.button('.buttons-csv').trigger();
}

function printTable() {
  patientsTable.button('.buttons-print').trigger();
}

function bulkActions() {
  const selected = document.querySelectorAll('.patient-checkbox:checked');
  if (selected.length === 0) {
    showNotification('Please select patients first', 'warning');
    return;
  }
  console.log('Bulk actions for:', Array.from(selected).map(cb => cb.value));
}

// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.patient-checkbox');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

function showNotification(message, type = 'info') {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = 'notification';
  
  const colors = {
    success: 'border-success',
    error: 'border-danger',
    warning: 'border-warning',
    info: 'border-info'
  };
  
  notification.classList.add(colors[type] || colors.info);
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill me-3 text-${type === 'error' ? 'danger' : type}"></i>
      <div class="flex-grow-1">
        <strong>${message}</strong>
      </div>
      <button type="button" class="btn-close btn-close-white ms-3" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  container.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}
</script>
{% endblock %}