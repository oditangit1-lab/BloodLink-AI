{% extends "base.html" %}
{% block title %}Donors - Blood Bank Management System{% endblock %}

{% block page_title %}Donors Management{% endblock %}
{% block page_subtitle %}Comprehensive donor database and analytics{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
  <button class="btn btn-outline-light btn-sm" onclick="exportDonors()">
    <i class="bi bi-download me-2"></i>
    Export
  </button>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDonorModal">
    <i class="bi bi-person-plus me-2"></i>
    Add Donor
  </button>
</div>
{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="stats-grid mb-3" style="grid-template-columns: repeat(4, 1fr); gap: 1rem;">
  <div class="stat-card success fade-in">
    <div class="stat-header">
      <div class="stat-title">Total Donors</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-people"></i>
      </div>
    </div>
    <div class="stat-value" id="totalDonors" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">Registered donors</div>
  </div>

  <div class="stat-card primary fade-in">
    <div class="stat-header">
      <div class="stat-title">Available Today</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-calendar-check"></i>
      </div>
    </div>
    <div class="stat-value" id="availableToday" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">Ready to donate</div>
  </div>

  <div class="stat-card warning fade-in">
    <div class="stat-header">
      <div class="stat-title">Active Cities</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-geo-alt"></i>
      </div>
    </div>
    <div class="stat-value" id="activeCities" style="font-size: 1.8rem;">-</div>
    <div class="stat-change">Coverage areas</div>
  </div>

  <div class="stat-card info fade-in">
    <div class="stat-header">
      <div class="stat-title">Blood Types</div>
      <div class="stat-icon" style="width: 32px; height: 32px;">
        <i class="bi bi-droplet"></i>
      </div>
    </div>
    <div class="stat-value" style="font-size: 1.8rem;">8</div>
    <div class="stat-change">All types covered</div>
  </div>
</div>

<!-- Filters Section -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-funnel me-2"></i>
      Filters & Search
    </h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Blood Type</label>
        <select class="form-select" id="bloodTypeFilter">
          <option value="">All Types</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">City</label>
        <select class="form-select" id="cityFilter">
          <option value="">All Cities</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Min Age</label>
        <input type="number" class="form-control" id="minAgeFilter" placeholder="18">
      </div>
      <div class="col-md-2">
        <label class="form-label">Max Age</label>
        <input type="number" class="form-control" id="maxAgeFilter" placeholder="65">
      </div>
      <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <button class="btn btn-primary w-100" onclick="applyFilters()">
          <i class="bi bi-search me-2"></i>
          Apply
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Donors Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-table me-2"></i>
      Donors Database
    </h5>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-light btn-sm" onclick="refreshTable()">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-three-dots"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-dark">
          <li><a class="dropdown-item" href="#" onclick="exportDonors()"><i class="bi bi-download me-2"></i>Export CSV</a></li>
          <li><a class="dropdown-item" href="#" onclick="printTable()"><i class="bi bi-printer me-2"></i>Print</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="bulkActions()"><i class="bi bi-gear me-2"></i>Bulk Actions</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table id="donorsTable" class="table table-dark table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th><input type="checkbox" class="form-check-input" id="selectAll"></th>
            <th>ID</th>
            <th>Name</th>
            <th>Blood Type</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Location</th>
            <th>Phone</th>
            <th>Last Donation</th>
            <th>Total Donations</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Donor Modal -->
<div class="modal fade" id="addDonorModal" tabindex="-1" aria-labelledby="addDonorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="addDonorModalLabel">
          <i class="bi bi-person-plus me-2"></i>
          Add New Donor
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addDonorForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Blood Type</label>
              <select class="form-select" name="blood_type" required>
                <option value="">Select Blood Type</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Age</label>
              <input type="number" class="form-control" name="age" min="18" max="65" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Gender</label>
              <select class="form-select" name="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="phone" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">City</label>
              <input type="text" class="form-control" name="city" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Hospital</label>
              <input type="text" class="form-control" name="hospital">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveDonor()">
          <i class="bi bi-check-lg me-2"></i>
          Save Donor
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables CSS & JS CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
let donorsTable;
let allDonors = [];

$(document).ready(function() {
  loadDonors();
});

function loadDonors() {
  fetch('/donors')
    .then(response => response.json())
    .then(data => {
      allDonors = data;
      updateStats(data);
      populateCityFilter(data);
      initializeTable(data);
    })
    .catch(error => {
      console.error('Error loading donors:', error);
      showNotification('Error loading donors data', 'error');
    });
}

function updateStats(donors) {
  document.getElementById('totalDonors').textContent = donors.length;
  
  // Calculate available today (donors eligible to donate)
  const today = new Date();
  const availableToday = donors.filter(donor => {
    if (!donor.next_eligible) return true;
    const nextEligible = new Date(donor.next_eligible);
    return nextEligible <= today;
  }).length;
  document.getElementById('availableToday').textContent = availableToday;
  
  // Count unique cities
  const cities = new Set(donors.map(d => d.location?.city).filter(Boolean));
  document.getElementById('activeCities').textContent = cities.size;
}

function populateCityFilter(donors) {
  const cities = [...new Set(donors.map(d => d.location?.city).filter(Boolean))].sort();
  const cityFilter = document.getElementById('cityFilter');
  cityFilter.innerHTML = '<option value="">All Cities</option>';
  cities.forEach(city => {
    cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
  });
}

function initializeTable(data) {
  if (donorsTable) {
    donorsTable.destroy();
  }
  
  donorsTable = $('#donorsTable').DataTable({
    data: data,
    columns: [
      { 
        data: null,
        orderable: false,
        render: function(data, type, row) {
          return `<input type="checkbox" class="form-check-input donor-checkbox" value="${row.donor_id}">`;
        }
      },
      { data: 'donor_id' },
      { 
        data: 'name',
        render: function(data, type, row) {
          return `<div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                      <i class="bi bi-person text-white"></i>
                    </div>
                    <strong>${data}</strong>
                  </div>`;
        }
      },
      { 
        data: 'blood_type',
        render: function(data, type, row) {
          const colors = {
            'A+': 'bg-danger', 'A-': 'bg-danger',
            'B+': 'bg-warning', 'B-': 'bg-warning',
            'AB+': 'bg-info', 'AB-': 'bg-info',
            'O+': 'bg-success', 'O-': 'bg-success'
          };
          return `<span class="badge ${colors[data] || 'bg-secondary'} rounded-pill">${data}</span>`;
        }
      },
      { data: 'age' },
      { 
        data: 'gender',
        render: function(data, type, row) {
          const icon = data === 'Male' ? 'bi-gender-male' : data === 'Female' ? 'bi-gender-female' : 'bi-gender-ambiguous';
          return `<i class="bi ${icon} me-1"></i>${data}`;
        }
      },
      { 
        data: 'location.city',
        defaultContent: '',
        render: function(data, type, row) {
          return data ? `<i class="bi bi-geo-alt me-1"></i>${data}` : '-';
        }
      },
      { 
        data: 'phone',
        defaultContent: '',
        render: function(data, type, row) {
          return data ? `<a href="tel:${data}" class="text-decoration-none"><i class="bi bi-telephone me-1"></i>${data}</a>` : '-';
        }
      },
      { 
        data: 'last_donation',
        defaultContent: '',
        render: function(data, type, row) {
          if (!data) return '-';
          const date = new Date(data);
          return `<small class="text-muted">${date.toLocaleDateString()}</small>`;
        }
      },
      { 
        data: 'total_donations',
        defaultContent: '0',
        render: function(data, type, row) {
          return `<span class="badge bg-outline-primary">${data || 0}</span>`;
        }
      },
      {
        data: null,
        orderable: false,
        render: function(data, type, row) {
          return `
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary btn-sm" onclick="viewDonor('${row.donor_id}')" title="View">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-outline-warning btn-sm" onclick="editDonor('${row.donor_id}')" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="contactDonor('${row.donor_id}')" title="Contact">
                <i class="bi bi-telephone"></i>
              </button>
            </div>
          `;
        }
      }
    ],
    responsive: true,
    pageLength: 25,
    order: [[1, 'asc']],
    dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center gap-2"l<"ms-2"f>><"ms-auto"B>>rtip',
    buttons: [
      {
        extend: 'csv',
        text: '<i class="bi bi-download me-1"></i>CSV',
        className: 'btn btn-outline-light btn-sm'
      },
      {
        extend: 'print',
        text: '<i class="bi bi-printer me-1"></i>Print',
        className: 'btn btn-outline-light btn-sm'
      }
    ],
    language: {
      search: '',
      searchPlaceholder: 'Search donors...',
      lengthMenu: 'Show _MENU_ donors',
      info: 'Showing _START_ to _END_ of _TOTAL_ donors',
      paginate: {
        previous: '<i class="bi bi-chevron-left"></i>',
        next: '<i class="bi bi-chevron-right"></i>'
      }
    },
    drawCallback: function() {
      // Style the search input
      $('.dataTables_filter input').addClass('form-control form-control-sm').attr('placeholder', 'Search donors...');
      $('.dataTables_length select').addClass('form-select form-select-sm');
    }
  });
}

function applyFilters() {
  const bloodType = document.getElementById('bloodTypeFilter').value;
  const city = document.getElementById('cityFilter').value;
  const minAge = document.getElementById('minAgeFilter').value;
  const maxAge = document.getElementById('maxAgeFilter').value;
  
  let filtered = allDonors;
  
  if (bloodType) {
    filtered = filtered.filter(d => d.blood_type === bloodType);
  }
  if (city) {
    filtered = filtered.filter(d => d.location?.city === city);
  }
  if (minAge) {
    filtered = filtered.filter(d => d.age >= parseInt(minAge));
  }
  if (maxAge) {
    filtered = filtered.filter(d => d.age <= parseInt(maxAge));
  }
  
  donorsTable.clear().rows.add(filtered).draw();
  updateStats(filtered);
}

function refreshTable() {
  loadDonors();
  showNotification('Donors data refreshed successfully', 'success');
}

function viewDonor(donorId) {
  const donor = allDonors.find(d => d.donor_id === donorId);
  if (donor) {
    // Implement view donor details
    console.log('View donor:', donor);
  }
}

function editDonor(donorId) {
  const donor = allDonors.find(d => d.donor_id === donorId);
  if (donor) {
    // Implement edit donor
    console.log('Edit donor:', donor);
  }
}

function contactDonor(donorId) {
  const donor = allDonors.find(d => d.donor_id === donorId);
  if (donor && donor.phone) {
    window.open(`tel:${donor.phone}`);
  }
}

function saveDonor() {
  // Implement save donor functionality
  const form = document.getElementById('addDonorForm');
  const formData = new FormData(form);
  
  // Here you would typically send the data to your backend
  console.log('Save donor:', Object.fromEntries(formData));
  
  // Close modal and refresh table
  bootstrap.Modal.getInstance(document.getElementById('addDonorModal')).hide();
  showNotification('Donor added successfully', 'success');
}

function exportDonors() {
  // Trigger DataTables CSV export
  donorsTable.button('.buttons-csv').trigger();
}

function printTable() {
  // Trigger DataTables print
  donorsTable.button('.buttons-print').trigger();
}

function bulkActions() {
  const selected = document.querySelectorAll('.donor-checkbox:checked');
  if (selected.length === 0) {
    showNotification('Please select donors first', 'warning');
    return;
  }
  console.log('Bulk actions for:', Array.from(selected).map(cb => cb.value));
}

// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.donor-checkbox');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

function showNotification(message, type = 'info') {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = 'notification';
  
  const colors = {
    success: 'border-success',
    error: 'border-danger',
    warning: 'border-warning',
    info: 'border-info'
  };
  
  notification.classList.add(colors[type] || colors.info);
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill me-3 text-${type === 'error' ? 'danger' : type}"></i>
      <div class="flex-grow-1">
        <strong>${message}</strong>
      </div>
      <button type="button" class="btn-close btn-close-white ms-3" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  container.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}
</script>
{% endblock %}